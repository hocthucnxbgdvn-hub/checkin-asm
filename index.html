<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Light Hotel - Check-in ASM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
      min-height: 100vh;
      padding: 12px;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1565c0 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    
    .content {
      padding: 20px;
    }
    
    .form-section {
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #5f6368;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #1a73e8;
      border-radius: 2px;
    }
    
    .required {
      color: #ea4335;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-group {
      flex: 1;
    }
    
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      color: #5f6368;
      margin-bottom: 6px;
    }
    
    select, input[type="text"], input[type="tel"], input[type="date"] {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
      background: #fff;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
    }
    
    .toggle-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .toggle-btn {
      flex: 1;
      min-width: 80px;
      padding: 10px 12px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      background: #fff;
      font-size: 0.9rem;
      font-weight: 500;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .toggle-btn:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }
    
    .toggle-btn.active {
      background: #1a73e8;
      border-color: #1a73e8;
      color: white;
    }
    
    /* Camera Section */
    .camera-section {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    #preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }
    
    .camera-placeholder {
      text-align: center;
      color: #9aa0a6;
      padding: 20px;
    }
    
    .camera-placeholder .icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    .camera-placeholder .text {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    
    .camera-placeholder .subtext {
      font-size: 0.8rem;
      color: #bdc1c6;
    }
    
    .camera-error {
      background: #fce8e6;
      color: #c5221f;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 12px;
      display: none;
    }
    
    .camera-error.show {
      display: block;
    }
    
    .camera-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn-camera, .btn-gallery, .btn-retake {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      flex: 1;
      justify-content: center;
      min-width: 140px;
    }
    
    .btn-camera {
      background: linear-gradient(135deg, #1a73e8 0%, #1565c0 100%);
      color: white;
    }
    
    .btn-camera:hover:not(:disabled) {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(26,115,232,0.4);
    }
    
    .btn-camera:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-gallery {
      background: #fff;
      color: #1a73e8;
      border: 2px solid #1a73e8;
    }
    
    .btn-gallery:hover {
      background: #e8f0fe;
    }
    
    .btn-retake {
      background: #f1f3f4;
      color: #5f6368;
      display: none;
    }
    
    .btn-retake:hover {
      background: #e8eaed;
    }
    
    /* Hidden file inputs */
    #fileInput, #cameraInput {
      display: none;
    }
    
    /* Submit Button */
    .btn-submit {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-submit:hover:not(:disabled) {
      transform: scale(1.01);
      box-shadow: 0 4px 15px rgba(52,168,83,0.4);
    }
    
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Status Messages */
    .status {
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      display: none;
      align-items: flex-start;
      gap: 10px;
    }
    
    .status.show {
      display: flex;
    }
    
    .status.loading {
      background: #e8f0fe;
      color: #1a73e8;
    }
    
    .status.success {
      background: #e6f4ea;
      color: #1e8e3e;
    }
    
    .status.error {
      background: #fce8e6;
      color: #c5221f;
    }
    
    .status.info {
      background: #fff3e0;
      color: #e65100;
    }
    
    .status-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .status-content {
      flex: 1;
    }
    
    .status-content strong {
      display: block;
      margin-bottom: 4px;
    }
    
    /* Result Card */
    .result-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      display: none;
    }
    
    .result-card.show {
      display: block;
    }
    
    .result-title {
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e8eaed;
      font-size: 0.9rem;
    }
    
    .result-row:last-child {
      border-bottom: none;
    }
    
    .result-label {
      color: #5f6368;
    }
    
    .result-value {
      font-weight: 500;
      color: #202124;
      text-align: right;
      max-width: 60%;
    }
    
    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(26,115,232,0.3);
      border-top-color: #1a73e8;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Room Grid */
    .room-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    .room-btn {
      padding: 12px 8px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      background: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .room-btn:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }
    
    .room-btn.selected {
      background: #1a73e8;
      border-color: #1a73e8;
      color: white;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e8eaed;
    }
    
    .btn-quick {
      flex: 1;
      padding: 12px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      background: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-quick:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 16px;
      color: #9aa0a6;
      font-size: 0.75rem;
      border-top: 1px solid #e8eaed;
    }
    
    /* Debug info */
    .debug-info {
      background: #f1f3f4;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      color: #5f6368;
      margin-top: 8px;
      font-family: monospace;
      display: none;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .debug-info.show {
      display: block;
    }

    /* Export info */
    .export-info {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 0.8rem;
      color: #1565c0;
      display: none;
    }

    .export-info.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè® Light Hotel</h1>
      <p>Check-in ASM</p>
    </div>
    
    <div class="content">
      <div id="status" class="status">
        <span class="status-icon"></span>
        <div class="status-content"></div>
      </div>
      
      <div class="form-section">
        <div class="section-title">1. Ch·ªçn ph√≤ng <span class="required">*</span></div>
        <div class="room-grid" id="roomGrid">
          <button class="room-btn" data-room="101">101</button>
          <button class="room-btn" data-room="102">102</button>
          <button class="room-btn" data-room="103">103</button>
          <button class="room-btn" data-room="104">104</button>
          <button class="room-btn" data-room="105">105</button>
          <button class="room-btn" data-room="106">106</button>
          <button class="room-btn" data-room="107">107</button>
          <button class="room-btn" data-room="108">108</button>
          <button class="room-btn" data-room="201">201</button>
          <button class="room-btn" data-room="202">202</button>
          <button class="room-btn" data-room="203">203</button>
          <button class="room-btn" data-room="204">204</button>
          <button class="room-btn" data-room="205">205</button>
          <button class="room-btn" data-room="206">206</button>
          <button class="room-btn" data-room="207">207</button>
          <button class="room-btn" data-room="208">208</button>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">2. Lo·∫°i kh√°ch</div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-guest="vn">üáªüá≥ Vi·ªát Nam</button>
          <button class="toggle-btn" data-guest="foreign">üåê N∆∞·ªõc ngo√†i</button>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">3. L√Ω do l∆∞u tr√∫ <span class="required">*</span></div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-reason="Du l·ªãch">Du l·ªãch</button>
          <button class="toggle-btn" data-reason="C√¥ng t√°c">C√¥ng t√°c</button>
          <button class="toggle-btn" data-reason="Ngh·ªâ ng∆°i">Ngh·ªâ ng∆°i</button>
          <button class="toggle-btn" data-reason="Kh√°c">Kh√°c</button>
        </div>
      </div>
      
      <div class="form-section" id="vnExtraFields">
        <div class="section-title">4. Lo·∫°i c∆∞ tr√∫</div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-residence="Th∆∞·ªùng tr√∫">Th∆∞·ªùng tr√∫</button>
          <button class="toggle-btn" data-residence="T·∫°m tr√∫">T·∫°m tr√∫</button>
          <button class="toggle-btn" data-residence="ƒê·ªãa ch·ªâ kh√°c">ƒê·ªãa ch·ªâ kh√°c</button>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">5. Th√¥ng tin th√™m (kh√¥ng b·∫Øt bu·ªôc)</div>
        <div class="form-row">
          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" id="phone" placeholder="09xxxxxxxx">
          </div>
          <div class="form-group">
            <label>Ng√†y check-out</label>
            <input type="date" id="checkoutDate">
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">6. Ch·ª•p ·∫£nh gi·∫•y t·ªù <span class="required">*</span></div>
        <div class="camera-section">
          <div id="cameraError" class="camera-error"></div>
          
          <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay playsinline muted></video>
            <img id="preview" alt="Preview">
            <div class="camera-placeholder" id="placeholder">
              <div class="icon">üì∑</div>
              <div class="text">Ch·ª•p ·∫£nh ho·∫∑c ch·ªçn t·ª´ th∆∞ vi·ªán</div>
              <div class="subtext">CCCD / CMND / H·ªô chi·∫øu</div>
            </div>
          </div>
          
          <div class="camera-buttons">
            <button class="btn-camera" id="btnCamera">
              <span>üì∏</span> Ch·ª•p ·∫£nh
            </button>
            <button class="btn-gallery" id="btnGallery">
              <span>üñºÔ∏è</span> Th∆∞ vi·ªán
            </button>
            <button class="btn-retake" id="btnRetake">
              <span>üîÑ</span> Ch·ª•p/Ch·ªçn l·∫°i
            </button>
          </div>
          
          <input type="file" id="fileInput" accept="image/*">

          <input type="file" id="cameraInput" accept="image/*" capture="environment">
          
          <div id="debugInfo" class="debug-info"></div>
        </div>
      </div>
      
      <button class="btn-submit" id="btnSubmit" disabled>
        <span>‚úÖ</span> X√°c nh·∫≠n Check-in
      </button>
      
      <div class="result-card" id="resultCard">
        <div class="result-title">
          <span>‚úÖ</span> Th√¥ng tin ƒë√£ ghi nh·∫≠n
        </div>
        <div id="resultContent"></div>
      </div>
      
      <div class="quick-actions">
        <button class="btn-quick" id="btnNewCheckin">
          ‚ûï Check-in kh√°ch m·ªõi
        </button>
        <button class="btn-quick" id="btnExportASM">
          üì§ Xu·∫•t ASM h√¥m nay
        </button>
      </div>

      <div class="export-info" id="exportInfo">
        <strong>üí° H∆∞·ªõng d·∫´n xu·∫•t ASM:</strong><br>
        1. Nh·∫•n "Xu·∫•t ASM h√¥m nay" ƒë·ªÉ t·∫°o sheet ASM_Export<br>
        2. M·ªü Google Sheet ‚Üí Tab "ASM_Export"<br>
        3. File ‚Üí Download ‚Üí Microsoft Excel (.xlsx)<br>
        4. Import file v√†o h·ªá th·ªëng ASM C√¥ng an
      </div>
    </div>
    
    <div class="footer">
      Light Hotel ¬© 2025 | Version 2.3 ASM<br>
      <span id="footerDebug" style="font-size: 0.65rem; color: #bdc1c6;"></span>
    </div>
  </div>
  
  <canvas id="canvas" style="display: none;"></canvas>
  
  <script>
    // ========== C·∫§U H√åNH ==========
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNeJL14Bvg3atDYv7uazYe-vo4_kp4djrfGaY_IM6lKkQUsbbTLjYQg9-GdkX2p9gOOg/exec';
    
    // Debug mode - set true ƒë·ªÉ xem th√¥ng tin debug
    const DEBUG_MODE = true;
    
    // ========== STATE ==========
    let selectedRoom = '';
    let isVietnamese = true;
    let lyDoLuuTru = 'Du l·ªãch';
    let loaiCuTru = 'Th∆∞·ªùng tr√∫';
    let capturedImage = null;
    let stream = null;
    let cameraActive = false;
    let isMobile = false;
    
    // ========== ELEMENTS ==========
    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const placeholder = document.getElementById('placeholder');
    const cameraError = document.getElementById('cameraError');
    const btnCamera = document.getElementById('btnCamera');
    const btnGallery = document.getElementById('btnGallery');
    const btnRetake = document.getElementById('btnRetake');
    const btnSubmit = document.getElementById('btnSubmit');
    const fileInput = document.getElementById('fileInput');
    const cameraInput = document.getElementById('cameraInput');
    const statusEl = document.getElementById('status');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');
    const vnExtraFields = document.getElementById('vnExtraFields');
    const debugInfo = document.getElementById('debugInfo');
    const exportInfo = document.getElementById('exportInfo');
    
    // ========== DETECT DEVICE ==========
    function detectDevice() {
      const ua = navigator.userAgent;
      isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      return isMobile;
    }
    
    // ========== DEBUG ==========
    function debug(message) {
      if (DEBUG_MODE) {
        console.log('[DEBUG]', message);
        const timestamp = new Date().toLocaleTimeString();
        const currentText = debugInfo.innerHTML;
        // Gi·ªØ 5 d√≤ng log g·∫ßn nh·∫•t
        const lines = currentText.split('\n').slice(-4);
        lines.push(`[${timestamp}] ${message}`);
        debugInfo.innerHTML = lines.join('\n');
        debugInfo.classList.add('show');
      }
    }
    
    // ========== CAMERA - MOBILE: D√πng input capture ==========
    function openCameraOnMobile() {
      debug('Mobile: M·ªü camera qua input capture');
      cameraInput.click();
    }
    
    // ========== CAMERA - DESKTOP: D√πng getUserMedia ==========
    async function startCameraOnDesktop() {
      debug('Desktop: ƒêang kh·ªüi ƒë·ªông camera stream...');
      cameraError.classList.remove('show');
      
      // Ki·ªÉm tra h·ªó tr·ª£
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showCameraError('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ camera. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.');
        debug('mediaDevices kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        return false;
      }
      
      try {
        // D·ª´ng stream c≈© n·∫øu c√≥
        stopCamera();
        
        const constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };
        
        debug('Requesting camera...');
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        debug('Camera stream nh·∫≠n ƒë∆∞·ª£c!');
        
        video.srcObject = stream;
        
        // ƒê·ª£i video s·∫µn s√†ng
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = () => {
            debug('Video metadata loaded');
            resolve();
          };
          video.onerror = (e) => {
            debug('Video error: ' + (e.message || 'unknown'));
            reject(e);
          };
          setTimeout(() => reject(new Error('Video load timeout')), 5000);
        });
        
        await video.play();
        debug(`Video ƒëang ph√°t: ${video.videoWidth}x${video.videoHeight}`);
        
        // Hi·ªÉn th·ªã video
        video.style.display = 'block';
        preview.style.display = 'none';
        placeholder.style.display = 'none';
        
        // ƒê·ªïi n√∫t th√†nh "Ch·ª•p"
        btnCamera.innerHTML = '<span>üì∏</span> CH·ª§P';
        btnCamera.onclick = captureFromCamera;
        btnGallery.style.display = 'none';
        btnRetake.style.display = 'none';
        
        cameraActive = true;
        return true;
        
      } catch (err) {
        debug('L·ªói camera: ' + err.name + ' - ' + err.message);
        
        let errorMessage = '';
        switch(err.name) {
          case 'NotAllowedError':
          case 'PermissionDeniedError':
            errorMessage = 'Quy·ªÅn camera b·ªã t·ª´ ch·ªëi. Vui l√≤ng:\n1. Nh·∫•n v√†o üîí tr√™n thanh ƒë·ªãa ch·ªâ\n2. Cho ph√©p quy·ªÅn Camera\n3. T·∫£i l·∫°i trang';
            break;
          case 'NotFoundError':
          case 'DevicesNotFoundError':
            errorMessage = 'Kh√¥ng t√¨m th·∫•y camera. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.';
            break;
          case 'NotReadableError':
          case 'TrackStartError':
            errorMessage = 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c. ƒê√≥ng c√°c app kh√°c v√† th·ª≠ l·∫°i.';
            break;
          case 'OverconstrainedError':
            errorMessage = 'Camera kh√¥ng h·ªó tr·ª£. ƒêang th·ª≠ camera kh√°c...';
            return await startCameraFallback();
          default:
            errorMessage = `L·ªói camera: ${err.message}. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.`;
        }
        
        showCameraError(errorMessage);
        return false;
      }
    }
    
    // Fallback v·ªõi constraints ƒë∆°n gi·∫£n
    async function startCameraFallback() {
      debug('Th·ª≠ camera fallback...');
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        
        video.srcObject = stream;
        await video.play();
        
        video.style.display = 'block';
        preview.style.display = 'none';
        placeholder.style.display = 'none';
        
        btnCamera.innerHTML = '<span>üì∏</span> CH·ª§P';
        btnCamera.onclick = captureFromCamera;
        btnGallery.style.display = 'none';
        
        cameraActive = true;
        debug('Camera fallback th√†nh c√¥ng!');
        return true;
        
      } catch (err) {
        debug('Camera fallback th·∫•t b·∫°i: ' + err.message);
        showCameraError('Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.');
        return false;
      }
    }
    
    function showCameraError(message) {
      cameraError.textContent = message;
      cameraError.classList.add('show');
      cameraActive = false;
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => {
          track.stop();
          debug('Stopped track: ' + track.kind);
        });
        stream = null;
      }
      video.srcObject = null;
      cameraActive = false;
    }
    
    function captureFromCamera() {
      if (!cameraActive) {
        debug('Camera kh√¥ng active, kh√¥ng th·ªÉ ch·ª•p');
        showCameraError('Camera ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
        return;
      }
      
      debug('Ch·ª•p ·∫£nh t·ª´ camera stream...');
      
      // Ki·ªÉm tra video dimensions
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        debug('Video dimensions = 0, waiting...');
        showCameraError('Camera ch∆∞a s·∫µn s√†ng. Vui l√≤ng ƒë·ª£i 1-2 gi√¢y r·ªìi th·ª≠ l·∫°i.');
        return;
      }
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      capturedImage = canvas.toDataURL('image/jpeg', 0.85);
      debug('·∫¢nh ƒë√£ ch·ª•p, size: ' + Math.round(capturedImage.length / 1024) + 'KB');
      
      showPreview(capturedImage);
      stopCamera();
    }
    
    function showPreview(imageData) {
      preview.src = imageData;
      preview.style.display = 'block';
      video.style.display = 'none';
      placeholder.style.display = 'none';
      
      btnCamera.style.display = 'none';
      btnGallery.style.display = 'none';
      btnRetake.style.display = 'flex';
      
      cameraError.classList.remove('show');
      updateSubmitButton();
      debug('Hi·ªÉn th·ªã preview ·∫£nh');
    }
    
    function resetCamera() {
      capturedImage = null;
      stopCamera();
      
      preview.style.display = 'none';
      video.style.display = 'none';
      placeholder.style.display = 'flex';
      
      btnCamera.innerHTML = '<span>üì∏</span> Ch·ª•p ·∫£nh';
      // Reset onclick d·ª±a tr√™n device
      btnCamera.onclick = isMobile ? openCameraOnMobile : startCameraOnDesktop;
      btnCamera.style.display = 'flex';
      btnGallery.style.display = 'flex';
      btnRetake.style.display = 'none';
      
      cameraError.classList.remove('show');
      updateSubmitButton();
      debug('Reset camera UI');
    }
    
    // ========== FILE INPUT (Gallery) - Kh√¥ng c√≥ capture ==========
    function openGallery() {
      debug('M·ªü th∆∞ vi·ªán ·∫£nh...');
      fileInput.click();
    }
    
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) {
        debug('Kh√¥ng c√≥ file ƒë∆∞·ª£c ch·ªçn');
        return;
      }
      
      debug('File ƒë∆∞·ª£c ch·ªçn: ' + file.name + ', size: ' + Math.round(file.size / 1024) + 'KB');
      
      // Ki·ªÉm tra lo·∫°i file
      if (!file.type.startsWith('image/')) {
        showCameraError('Vui l√≤ng ch·ªçn file ·∫£nh (JPG, PNG...)');
        return;
      }
      
      // Ki·ªÉm tra k√≠ch th∆∞·ªõc (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showCameraError('·∫¢nh qu√° l·ªõn (>10MB). Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        capturedImage = event.target.result;
        debug('·∫¢nh ƒë√£ load, size: ' + Math.round(capturedImage.length / 1024) + 'KB');
        showPreview(capturedImage);
      };
      reader.onerror = function() {
        showCameraError('Kh√¥ng th·ªÉ ƒë·ªçc file ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
        debug('FileReader error');
      };
      reader.readAsDataURL(file);
      
      // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng file
      e.target.value = '';
    }
    
    // ========== CAMERA INPUT (Mobile camera capture) ==========
    function handleCameraCapture(e) {
      debug('X·ª≠ l√Ω ·∫£nh t·ª´ camera mobile...');
      handleFileSelect(e);
    }
    
    // ========== ROOM SELECTION ==========
    document.getElementById('roomGrid').addEventListener('click', (e) => {
      if (e.target.classList.contains('room-btn')) {
        document.querySelectorAll('.room-btn').forEach(btn => btn.classList.remove('selected'));
        e.target.classList.add('selected');
        selectedRoom = e.target.dataset.room;
        debug('Ph√≤ng ƒë∆∞·ª£c ch·ªçn: ' + selectedRoom);
        updateSubmitButton();
      }
    });
    
    // ========== TOGGLE BUTTONS ==========
    document.querySelectorAll('[data-guest]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-guest]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        isVietnamese = btn.dataset.guest === 'vn';
        vnExtraFields.style.display = isVietnamese ? 'block' : 'none';
        debug('Lo·∫°i kh√°ch: ' + (isVietnamese ? 'Vi·ªát Nam' : 'N∆∞·ªõc ngo√†i'));
      });
    });
    
    document.querySelectorAll('[data-reason]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-reason]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        lyDoLuuTru = btn.dataset.reason;
        debug('L√Ω do: ' + lyDoLuuTru);
      });
    });
    
    document.querySelectorAll('[data-residence]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-residence]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loaiCuTru = btn.dataset.residence;
        debug('Lo·∫°i c∆∞ tr√∫: ' + loaiCuTru);
      });
    });
    
    // ========== VALIDATION ==========
    function updateSubmitButton() {
      const canSubmit = selectedRoom && capturedImage;
      btnSubmit.disabled = !canSubmit;
      debug('Submit button: ' + (canSubmit ? 'enabled' : 'disabled'));
    }
    
    // ========== STATUS ==========
    function showStatus(type, title, message) {
      const icons = {
        loading: '<div class="spinner"></div>',
        success: '‚úÖ',
        error: '‚ùå',
        info: 'üí°'
      };
      
      statusEl.className = `status show ${type}`;
      statusEl.innerHTML = `
        <span class="status-icon">${icons[type]}</span>
        <div class="status-content">
          <strong>${title}</strong>
          <span>${message}</span>
        </div>
      `;
    }
    
    function hideStatus() {
      statusEl.className = 'status';
    }

    // ========== QR CODE READER ==========
    function tryReadQRCode(imageData) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
          // T·∫°o canvas ƒë·ªÉ ƒë·ªçc QR
          const qrCanvas = document.createElement('canvas');
          const ctx = qrCanvas.getContext('2d');
          qrCanvas.width = img.width;
          qrCanvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          // L·∫•y image data
          const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
          
          // ƒê·ªçc QR code
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          
          if (code && code.data) {
            debug('QR Code found: ' + code.data.substring(0, 50) + '...');
            const parsed = parseQRCodeCCCD(code.data);
            resolve(parsed);
          } else {
            debug('No QR code found, will use AI OCR');
            resolve(null);
          }
        };
        img.onerror = function() {
          debug('Error loading image for QR scan');
          resolve(null);
        };
        img.src = imageData;
      });
    }

    // Parse QR code CCCD Vi·ªát Nam
    // Format: 034200003259|Nguyen Phuong Truong|20072000|Nam|Dia chi day du|18062025
    function parseQRCodeCCCD(qrData) {
      try {
        // Ki·ªÉm tra c√≥ ph·∫£i QR CCCD kh√¥ng (b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 12 ch·ªØ s·ªë)
        if (!/^\d{12}\|/.test(qrData)) {
          debug('QR kh√¥ng ph·∫£i CCCD format');
          return null;
        }
        
        const parts = qrData.split('|');
        if (parts.length < 5) {
          debug('QR CCCD kh√¥ng ƒë·ªß ph·∫ßn t·ª≠: ' + parts.length);
          return null;
        }
        
        const soGiayTo = parts[0];
        const hoTen = parts[1].toUpperCase();
        const ngaySinhRaw = parts[2]; // DDMMYYYY
        const gioiTinh = parts[3];
        const diaChiFull = parts[4];
        
        // Parse ng√†y sinh t·ª´ DDMMYYYY sang DD/MM/YYYY
        let ngaySinh = '';
        if (ngaySinhRaw && ngaySinhRaw.length === 8) {
          ngaySinh = ngaySinhRaw.substring(0, 2) + '/' + 
                     ngaySinhRaw.substring(2, 4) + '/' + 
                     ngaySinhRaw.substring(4, 8);
        }
        
        // Parse ƒë·ªãa ch·ªâ
        const addressParts = diaChiFull.split(',').map(p => p.trim());
        let tinh = '', huyen = '', xa = '', chiTiet = '';
        
        if (addressParts.length >= 4) {
          chiTiet = addressParts.slice(0, -3).join(', ');
          xa = addressParts[addressParts.length - 3];
          huyen = addressParts[addressParts.length - 2];
          tinh = addressParts[addressParts.length - 1];
        } else if (addressParts.length === 3) {
          xa = addressParts[0];
          huyen = addressParts[1];
          tinh = addressParts[2];
        } else if (addressParts.length === 2) {
          huyen = addressParts[0];
          tinh = addressParts[1];
        } else {
          tinh = diaChiFull;
        }
        
        debug('QR parsed successfully: ' + hoTen);
        
        return {
          fromQR: true,
          loaiGiayTo: 'CCCD',
          soGiayTo: soGiayTo,
          hoTen: hoTen,
          ngaySinh: ngaySinh,
          gioiTinh: gioiTinh,
          quocTich: 'Vi·ªát Nam',
          noiThuongTru: diaChiFull,
          tinhThanh: tinh,
          quanHuyen: huyen,
          phuongXa: xa,
          diaChiChiTiet: chiTiet
        };
      } catch (e) {
        debug('Error parsing QR: ' + e.message);
        return null;
      }
    }
    
    // ========== HELPERS ==========
    function getTomorrow() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      return tomorrow.toISOString().split('T')[0];
    }
    
    // ========== SUBMIT ==========
    async function submitCheckin() {
      if (!selectedRoom || !capturedImage) {
        showStatus('error', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng ch·ªçn ph√≤ng v√† ch·ª•p ·∫£nh gi·∫•y t·ªù');
        return;
      }
      
      if (APPS_SCRIPT_URL === 'THAY_URL_WEB_APP_V√ÄO_ƒê√ÇY') {
        showStatus('error', 'Ch∆∞a c·∫•u h√¨nh', 'Vui l√≤ng c·∫≠p nh·∫≠t APPS_SCRIPT_URL trong code');
        return;
      }
      
      btnSubmit.disabled = true;
      resultCard.classList.remove('show');
      
      // B∆Ø·ªöC 1: Th·ª≠ ƒë·ªçc QR Code tr∆∞·ªõc
      showStatus('loading', 'ƒêang x·ª≠ l√Ω...', 'ƒêang ki·ªÉm tra m√£ QR...');
      
      let qrData = null;
      try {
        qrData = await tryReadQRCode(capturedImage);
      } catch (e) {
        debug('QR read error: ' + e.message);
      }
      
      // B∆Ø·ªöC 2: G·ª≠i request v·ªõi flag useQR
      showStatus('loading', 'ƒêang x·ª≠ l√Ω...', qrData ? 'ƒê√£ ƒë·ªçc QR, ƒëang x√°c nh·∫≠n...' : 'ƒêang ƒë·ªçc th√¥ng tin b·∫±ng AI...');
      
      debug('ƒêang g·ª≠i request...');
      
      try {
        const requestBody = {
          action: 'checkin',
          image: capturedImage,
          roomNumber: selectedRoom,
          checkoutDate: document.getElementById('checkoutDate').value,
          lyDoLuuTru: lyDoLuuTru,
          loaiCuTru: loaiCuTru,
          isVietnamese: isVietnamese,
          phone: document.getElementById('phone').value,
          // G·ª≠i d·ªØ li·ªáu QR n·∫øu c√≥
          qrData: qrData
        };
        
        debug('Request size: ' + Math.round(JSON.stringify(requestBody).length / 1024) + 'KB');
        if (qrData) {
          debug('QR data included: ' + qrData.hoTen);
        }
        
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify(requestBody)
        });
        
        debug('Response status: ' + response.status);
        
        const result = await response.json();
        debug('Response received');
        
        if (result.success) {
          const info = result.data.info;
          const source = result.data.source || 'AI'; // 'QR' ho·∫∑c 'AI'
          showStatus('success', 'Check-in th√†nh c√¥ng!', 
            `Kh√°ch ${info.hoTen} ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n` + (source === 'QR' ? ' (t·ª´ QR)' : ''));
          
          resultContent.innerHTML = `
            <div class="result-row">
              <span class="result-label">H·ªç t√™n</span>
              <span class="result-value">${info.hoTen || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Ng√†y sinh</span>
              <span class="result-value">${info.ngaySinh || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Gi·ªõi t√≠nh</span>
              <span class="result-value">${info.gioiTinh || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Qu·ªëc t·ªãch</span>
              <span class="result-value">${info.quocTich || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Lo·∫°i gi·∫•y t·ªù</span>
              <span class="result-value">${info.loaiGiayTo || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">S·ªë gi·∫•y t·ªù</span>
              <span class="result-value">${info.soGiayTo || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Ph√≤ng</span>
              <span class="result-value">${info.tenPhong || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Check-in</span>
              <span class="result-value">${info.thoiGianTu || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Ngu·ªìn d·ªØ li·ªáu</span>
              <span class="result-value">${source === 'QR' ? 'üì± QR Code' : 'ü§ñ AI OCR'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">STT</span>
              <span class="result-value">#${result.data.stt}</span>
            </div>
          `;
          resultCard.classList.add('show');
          
        } else {
          showStatus('error', 'L·ªói x·ª≠ l√Ω', result.error || 'Kh√¥ng th·ªÉ ƒë·ªçc th√¥ng tin. Vui l√≤ng ch·ª•p l·∫°i ·∫£nh r√µ h∆°n.');
          btnSubmit.disabled = false;
        }
        
      } catch (error) {
        debug('Fetch error: ' + error.message);
        showStatus('error', 'L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server. Ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.');
        btnSubmit.disabled = false;
      }
    }

    // ========== EVENT LISTENERS ==========
    // Camera button - behavior depends on device
    btnCamera.addEventListener('click', function() {
      if (isMobile) {
        openCameraOnMobile();
      } else {
        startCameraOnDesktop();
      }
    });
    
    btnGallery.addEventListener('click', openGallery);
    btnRetake.addEventListener('click', resetCamera);
    btnSubmit.addEventListener('click', submitCheckin);
    
    // File inputs - m·ªói input ch·ªâ x·ª≠ l√Ω 1 l·∫ßn
    fileInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        handleFileSelect(e);
      }
    });

    cameraInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        handleFileSelect(e);
        // Reset ƒë·ªÉ c√≥ th·ªÉ ch·ª•p l·∫°i
        cameraInput.value = '';
      }
    });
    
    // Quick actions
    document.getElementById('btnNewCheckin').addEventListener('click', newCheckin);
    document.getElementById('btnExportASM').addEventListener('click', exportASM);
    
    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Detect device
      detectDevice();
      debug('App kh·ªüi ƒë·ªông - ' + (isMobile ? 'Mobile' : 'Desktop'));
      
      // Set default checkout date
      document.getElementById('checkoutDate').value = getTomorrow();
      
      // Show device info
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      const isAndroid = /Android/.test(ua);
      document.getElementById('footerDebug').textContent = 
        (isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop') + ' | ' + 
        (navigator.mediaDevices ? 'Camera API OK' : 'No Camera API');
      
      debug('mediaDevices: ' + !!navigator.mediaDevices);
      
      // Update camera button text for mobile
      if (isMobile) {
        btnCamera.innerHTML = '<span>üì∏</span> Ch·ª•p ·∫£nh';
        debug('Mobile mode: Camera s·∫Ω d√πng input capture');
      }
    });
  </script>
</body>
</html>
