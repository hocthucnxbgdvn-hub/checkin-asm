<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Light Hotel - Check-in ASM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
      min-height: 100vh;
      padding: 12px;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1565c0 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    
    .content {
      padding: 20px;
    }
    
    .form-section {
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #5f6368;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #1a73e8;
      border-radius: 2px;
    }
    
    .required {
      color: #ea4335;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-group {
      flex: 1;
    }
    
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      color: #5f6368;
      margin-bottom: 6px;
    }
    
    select, input[type="text"], input[type="tel"], input[type="date"] {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
      background: #fff;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
    }
    
    .toggle-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .toggle-btn {
      flex: 1;
      min-width: 80px;
      padding: 10px 12px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      background: #fff;
      font-size: 0.9rem;
      font-weight: 500;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .toggle-btn:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }
    
    .toggle-btn.active {
      background: #1a73e8;
      border-color: #1a73e8;
      color: white;
    }
    
    /* Camera Section */
    .camera-section {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    #preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }
    
    .camera-placeholder {
      text-align: center;
      color: #9aa0a6;
      padding: 20px;
    }
    
    .camera-placeholder .icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    .camera-placeholder .text {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    
    .camera-placeholder .subtext {
      font-size: 0.8rem;
      color: #bdc1c6;
    }
    
    .camera-error {
      background: #fce8e6;
      color: #c5221f;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 12px;
      display: none;
    }
    
    .camera-error.show {
      display: block;
    }
    
    .camera-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn-camera, .btn-gallery, .btn-retake {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      flex: 1;
      justify-content: center;
      min-width: 140px;
    }
    
    .btn-camera {
      background: linear-gradient(135deg, #1a73e8 0%, #1565c0 100%);
      color: white;
    }
    
    .btn-camera:hover:not(:disabled) {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(26,115,232,0.4);
    }
    
    .btn-camera:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-gallery {
      background: #fff;
      color: #1a73e8;
      border: 2px solid #1a73e8;
    }
    
    .btn-gallery:hover {
      background: #e8f0fe;
    }
    
    .btn-retake {
      background: #f1f3f4;
      color: #5f6368;
      display: none;
    }
    
    .btn-retake:hover {
      background: #e8eaed;
    }
    
    /* Hidden file input */
    #fileInput {
      display: none;
    }
    
    /* Submit Button */
    .btn-submit {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-submit:hover:not(:disabled) {
      transform: scale(1.01);
      box-shadow: 0 4px 15px rgba(52,168,83,0.4);
    }
    
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Status Messages */
    .status {
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      display: none;
      align-items: flex-start;
      gap: 10px;
    }
    
    .status.show {
      display: flex;
    }
    
    .status.loading {
      background: #e8f0fe;
      color: #1a73e8;
    }
    
    .status.success {
      background: #e6f4ea;
      color: #1e8e3e;
    }
    
    .status.error {
      background: #fce8e6;
      color: #c5221f;
    }
    
    .status-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .status-content {
      flex: 1;
    }
    
    .status-content strong {
      display: block;
      margin-bottom: 4px;
    }
    
    /* Result Card */
    .result-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      display: none;
    }
    
    .result-card.show {
      display: block;
    }
    
    .result-title {
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e8eaed;
      font-size: 0.9rem;
    }
    
    .result-row:last-child {
      border-bottom: none;
    }
    
    .result-label {
      color: #5f6368;
    }
    
    .result-value {
      font-weight: 500;
      color: #202124;
      text-align: right;
      max-width: 60%;
    }
    
    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(26,115,232,0.3);
      border-top-color: #1a73e8;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Room Grid */
    .room-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    .room-btn {
      padding: 12px 8px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      background: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .room-btn:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }
    
    .room-btn.selected {
      background: #1a73e8;
      border-color: #1a73e8;
      color: white;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e8eaed;
    }
    
    .btn-quick {
      flex: 1;
      padding: 12px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      background: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-quick:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 16px;
      color: #9aa0a6;
      font-size: 0.75rem;
      border-top: 1px solid #e8eaed;
    }
    
    /* Debug info */
    .debug-info {
      background: #f1f3f4;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      color: #5f6368;
      margin-top: 8px;
      font-family: monospace;
      display: none;
    }
    
    .debug-info.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè® Light Hotel</h1>
      <p>Check-in kh√°ch - T∆∞∆°ng th√≠ch ASM</p>
    </div>
    
    <div class="content">
      <!-- Status Messages -->
      <div id="status" class="status">
        <span class="status-icon"></span>
        <div class="status-content"></div>
      </div>
      
      <!-- Room Selection -->
      <div class="form-section">
        <div class="section-title">1. Ch·ªçn ph√≤ng <span class="required">*</span></div>
        <div class="room-grid" id="roomGrid">
          <button class="room-btn" data-room="101">101</button>
          <button class="room-btn" data-room="102">102</button>
          <button class="room-btn" data-room="103">103</button>
          <button class="room-btn" data-room="104">104</button>
          <button class="room-btn" data-room="105">105</button>
          <button class="room-btn" data-room="106">106</button>
          <button class="room-btn" data-room="107">107</button>
          <button class="room-btn" data-room="108">108</button>
          <button class="room-btn" data-room="201">201</button>
          <button class="room-btn" data-room="202">202</button>
          <button class="room-btn" data-room="203">203</button>
          <button class="room-btn" data-room="204">204</button>
          <button class="room-btn" data-room="205">205</button>
          <button class="room-btn" data-room="206">206</button>
          <button class="room-btn" data-room="207">207</button>
          <button class="room-btn" data-room="208">208</button>
        </div>
      </div>
      
      <!-- Guest Type -->
      <div class="form-section">
        <div class="section-title">2. Lo·∫°i kh√°ch</div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-guest="vn">üáªüá≥ Vi·ªát Nam</button>
          <button class="toggle-btn" data-guest="foreign">üåç N∆∞·ªõc ngo√†i</button>
        </div>
      </div>
      
      <!-- Stay Reason -->
      <div class="form-section">
        <div class="section-title">3. L√Ω do l∆∞u tr√∫ <span class="required">*</span></div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-reason="Du l·ªãch">Du l·ªãch</button>
          <button class="toggle-btn" data-reason="C√¥ng t√°c">C√¥ng t√°c</button>
          <button class="toggle-btn" data-reason="Ngh·ªâ ng∆°i">Ngh·ªâ ng∆°i</button>
          <button class="toggle-btn" data-reason="Kh√°c">Kh√°c</button>
        </div>
      </div>
      
      <!-- Residence Type (Vietnamese only) -->
      <div class="form-section" id="vnExtraFields">
        <div class="section-title">4. Lo·∫°i c∆∞ tr√∫</div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-residence="Th∆∞·ªùng tr√∫">Th∆∞·ªùng tr√∫</button>
          <button class="toggle-btn" data-residence="T·∫°m tr√∫">T·∫°m tr√∫</button>
          <button class="toggle-btn" data-residence="ƒê·ªãa ch·ªâ kh√°c">ƒê·ªãa ch·ªâ kh√°c</button>
        </div>
      </div>
      
      <!-- Optional Fields -->
      <div class="form-section">
        <div class="section-title">5. Th√¥ng tin th√™m (kh√¥ng b·∫Øt bu·ªôc)</div>
        <div class="form-row">
          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" id="phone" placeholder="09xxxxxxxx">
          </div>
          <div class="form-group">
            <label>Ng√†y check-out</label>
            <input type="date" id="checkoutDate">
          </div>
        </div>
      </div>
      
      <!-- Camera Section -->
      <div class="form-section">
        <div class="section-title">6. Ch·ª•p ·∫£nh gi·∫•y t·ªù <span class="required">*</span></div>
        <div class="camera-section">
          <!-- Camera Error Message -->
          <div id="cameraError" class="camera-error"></div>
          
          <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay playsinline muted></video>
            <img id="preview" alt="Preview">
            <div class="camera-placeholder" id="placeholder">
              <div class="icon">üì∑</div>
              <div class="text">Ch·ª•p ·∫£nh ho·∫∑c ch·ªçn t·ª´ th∆∞ vi·ªán</div>
              <div class="subtext">CCCD / CMND / H·ªô chi·∫øu</div>
            </div>
          </div>
          
          <div class="camera-buttons">
            <button class="btn-camera" id="btnCamera">
              <span>üì∏</span> M·ªü Camera
            </button>
            <button class="btn-gallery" id="btnGallery">
              <span>üñºÔ∏è</span> Th∆∞ vi·ªán
            </button>
            <button class="btn-retake" id="btnRetake">
              <span>üîÑ</span> Ch·ª•p/Ch·ªçn l·∫°i
            </button>
          </div>
          
          <!-- Hidden file input for gallery -->
          <input type="file" id="fileInput" accept="image/*" capture="environment">
          
          <!-- Debug info -->
          <div id="debugInfo" class="debug-info"></div>
        </div>
      </div>
      
      <!-- Submit Button -->
      <button class="btn-submit" id="btnSubmit" disabled>
        <span>‚úÖ</span> X√°c nh·∫≠n Check-in
      </button>
      
      <!-- Result Card -->
      <div class="result-card" id="resultCard">
        <div class="result-title">
          <span>‚úÖ</span> Th√¥ng tin ƒë√£ ghi nh·∫≠n
        </div>
        <div id="resultContent"></div>
      </div>
      
      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="btn-quick" id="btnNewCheckin">
          ‚ûï Check-in kh√°ch m·ªõi
        </button>
        <button class="btn-quick" id="btnExportASM">
          üì§ Xu·∫•t ASM
        </button>
      </div>
    </div>
    
    <div class="footer">
      Light Hotel ¬© 2025 | Version 2.1 ASM<br>
      <span id="footerDebug" style="font-size: 0.65rem; color: #bdc1c6;"></span>
    </div>
  </div>
  
  <canvas id="canvas" style="display: none;"></canvas>
  
  <script>
    // ========== C·∫§U H√åNH ==========
    // ‚ö†Ô∏è THAY URL N√ÄY B·∫∞NG URL C·ª¶A ANH SAU KHI DEPLOY APPS SCRIPT
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNeJL14Bvg3atDYv7uazYe-vo4_kp4djrfGaY_IM6lKkQUsbbTLjYQg9-GdkX2p9gOOg/exec';
    
    // Debug mode - set true ƒë·ªÉ xem th√¥ng tin debug
    const DEBUG_MODE = true;
    
    // ========== STATE ==========
    let selectedRoom = '';
    let isVietnamese = true;
    let lyDoLuuTru = 'Du l·ªãch';
    let loaiCuTru = 'Th∆∞·ªùng tr√∫';
    let capturedImage = null;
    let stream = null;
    let cameraActive = false;
    
    // ========== ELEMENTS ==========
    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const placeholder = document.getElementById('placeholder');
    const cameraError = document.getElementById('cameraError');
    const btnCamera = document.getElementById('btnCamera');
    const btnGallery = document.getElementById('btnGallery');
    const btnRetake = document.getElementById('btnRetake');
    const btnSubmit = document.getElementById('btnSubmit');
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');
    const vnExtraFields = document.getElementById('vnExtraFields');
    const debugInfo = document.getElementById('debugInfo');
    
    // ========== DEBUG ==========
    function debug(message) {
      if (DEBUG_MODE) {
        console.log('[DEBUG]', message);
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML = `[${timestamp}] ${message}`;
        debugInfo.classList.add('show');
      }
    }
    
    // ========== CAMERA ==========
    async function startCamera() {
      debug('ƒêang kh·ªüi ƒë·ªông camera...');
      cameraError.classList.remove('show');
      
      // Ki·ªÉm tra h·ªó tr·ª£
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showCameraError('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ camera. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.');
        debug('mediaDevices kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        return false;
      }
      
      try {
        // D·ª´ng stream c≈© n·∫øu c√≥
        stopCamera();
        
        // Th·ª≠ camera sau (environment) tr∆∞·ªõc
        const constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };
        
        debug('Requesting camera v·ªõi constraints: ' + JSON.stringify(constraints.video.facingMode));
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        debug('Camera stream nh·∫≠n ƒë∆∞·ª£c!');
        
        video.srcObject = stream;
        
        // ƒê·ª£i video s·∫µn s√†ng
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = () => {
            debug('Video metadata loaded');
            resolve();
          };
          video.onerror = (e) => {
            debug('Video error: ' + e.message);
            reject(e);
          };
          setTimeout(() => reject(new Error('Video load timeout')), 5000);
        });
        
        await video.play();
        debug('Video ƒëang ph√°t, k√≠ch th∆∞·ªõc: ' + video.videoWidth + 'x' + video.videoHeight);
        
        // Hi·ªÉn th·ªã video
        video.style.display = 'block';
        preview.style.display = 'none';
        placeholder.style.display = 'none';
        
        // ƒê·ªïi n√∫t
        btnCamera.innerHTML = '<span>üì∏</span> Ch·ª•p ·∫£nh';
        btnCamera.onclick = captureFromCamera;
        btnGallery.style.display = 'none';
        btnRetake.style.display = 'none';
        
        cameraActive = true;
        return true;
        
      } catch (err) {
        debug('L·ªói camera: ' + err.name + ' - ' + err.message);
        
        let errorMessage = '';
        switch(err.name) {
          case 'NotAllowedError':
          case 'PermissionDeniedError':
            errorMessage = 'Quy·ªÅn camera b·ªã t·ª´ ch·ªëi. Vui l√≤ng:\n1. Nh·∫•n v√†o üîí tr√™n thanh ƒë·ªãa ch·ªâ\n2. Cho ph√©p quy·ªÅn Camera\n3. T·∫£i l·∫°i trang';
            break;
          case 'NotFoundError':
          case 'DevicesNotFoundError':
            errorMessage = 'Kh√¥ng t√¨m th·∫•y camera. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.';
            break;
          case 'NotReadableError':
          case 'TrackStartError':
            errorMessage = 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c. ƒê√≥ng c√°c app kh√°c v√† th·ª≠ l·∫°i.';
            break;
          case 'OverconstrainedError':
            errorMessage = 'Camera kh√¥ng h·ªó tr·ª£. ƒêang th·ª≠ camera kh√°c...';
            // Th·ª≠ l·∫°i v·ªõi constraints ƒë∆°n gi·∫£n h∆°n
            return await startCameraFallback();
          case 'AbortError':
            errorMessage = 'Camera b·ªã h·ªßy. Vui l√≤ng th·ª≠ l·∫°i.';
            break;
          default:
            errorMessage = `L·ªói camera: ${err.message}. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.`;
        }
        
        showCameraError(errorMessage);
        return false;
      }
    }
    
    // Fallback v·ªõi constraints ƒë∆°n gi·∫£n
    async function startCameraFallback() {
      debug('Th·ª≠ camera fallback...');
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        
        video.srcObject = stream;
        await video.play();
        
        video.style.display = 'block';
        preview.style.display = 'none';
        placeholder.style.display = 'none';
        
        btnCamera.innerHTML = '<span>üì∏</span> Ch·ª•p ·∫£nh';
        btnCamera.onclick = captureFromCamera;
        btnGallery.style.display = 'none';
        
        cameraActive = true;
        debug('Camera fallback th√†nh c√¥ng!');
        return true;
        
      } catch (err) {
        debug('Camera fallback th·∫•t b·∫°i: ' + err.message);
        showCameraError('Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng d√πng n√∫t "Th∆∞ vi·ªán" ƒë·ªÉ ch·ªçn ·∫£nh.');
        return false;
      }
    }
    
    function showCameraError(message) {
      cameraError.textContent = message;
      cameraError.classList.add('show');
      cameraActive = false;
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => {
          track.stop();
          debug('Stopped track: ' + track.kind);
        });
        stream = null;
      }
      video.srcObject = null;
      cameraActive = false;
    }
    
    function captureFromCamera() {
      if (!cameraActive) {
        debug('Camera kh√¥ng active, kh√¥ng th·ªÉ ch·ª•p');
        return;
      }
      
      debug('Ch·ª•p ·∫£nh t·ª´ camera...');
      
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      capturedImage = canvas.toDataURL('image/jpeg', 0.85);
      debug('·∫¢nh ƒë√£ ch·ª•p, size: ' + Math.round(capturedImage.length / 1024) + 'KB');
      
      showPreview(capturedImage);
      stopCamera();
    }
    
    function showPreview(imageData) {
      preview.src = imageData;
      preview.style.display = 'block';
      video.style.display = 'none';
      placeholder.style.display = 'none';
      
      btnCamera.style.display = 'none';
      btnGallery.style.display = 'none';
      btnRetake.style.display = 'flex';
      
      updateSubmitButton();
    }
    
    function resetCamera() {
      capturedImage = null;
      stopCamera();
      
      preview.style.display = 'none';
      video.style.display = 'none';
      placeholder.style.display = 'flex';
      
      btnCamera.innerHTML = '<span>üì∏</span> M·ªü Camera';
      btnCamera.onclick = startCamera;
      btnCamera.style.display = 'flex';
      btnGallery.style.display = 'flex';
      btnRetake.style.display = 'none';
      
      cameraError.classList.remove('show');
      updateSubmitButton();
    }
    
    // ========== FILE INPUT (Gallery) ==========
    function openGallery() {
      debug('M·ªü th∆∞ vi·ªán ·∫£nh...');
      fileInput.click();
    }
    
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) {
        debug('Kh√¥ng c√≥ file ƒë∆∞·ª£c ch·ªçn');
        return;
      }
      
      debug('File ƒë∆∞·ª£c ch·ªçn: ' + file.name + ', size: ' + Math.round(file.size / 1024) + 'KB');
      
      // Ki·ªÉm tra lo·∫°i file
      if (!file.type.startsWith('image/')) {
        showCameraError('Vui l√≤ng ch·ªçn file ·∫£nh (JPG, PNG...)');
        return;
      }
      
      // Ki·ªÉm tra k√≠ch th∆∞·ªõc (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showCameraError('·∫¢nh qu√° l·ªõn (>10MB). Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        capturedImage = event.target.result;
        debug('·∫¢nh ƒë√£ load, size: ' + Math.round(capturedImage.length / 1024) + 'KB');
        showPreview(capturedImage);
      };
      reader.onerror = function() {
        showCameraError('Kh√¥ng th·ªÉ ƒë·ªçc file ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
        debug('FileReader error');
      };
      reader.readAsDataURL(file);
    }
    
    // ========== ROOM SELECTION ==========
    document.getElementById('roomGrid').addEventListener('click', (e) => {
      if (e.target.classList.contains('room-btn')) {
        document.querySelectorAll('.room-btn').forEach(btn => btn.classList.remove('selected'));
        e.target.classList.add('selected');
        selectedRoom = e.target.dataset.room;
        debug('Ph√≤ng ƒë∆∞·ª£c ch·ªçn: ' + selectedRoom);
        updateSubmitButton();
      }
    });
    
    // ========== TOGGLE BUTTONS ==========
    document.querySelectorAll('[data-guest]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-guest]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        isVietnamese = btn.dataset.guest === 'vn';
        vnExtraFields.style.display = isVietnamese ? 'block' : 'none';
        debug('Lo·∫°i kh√°ch: ' + (isVietnamese ? 'Vi·ªát Nam' : 'N∆∞·ªõc ngo√†i'));
      });
    });
    
    document.querySelectorAll('[data-reason]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-reason]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        lyDoLuuTru = btn.dataset.reason;
        debug('L√Ω do: ' + lyDoLuuTru);
      });
    });
    
    document.querySelectorAll('[data-residence]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-residence]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loaiCuTru = btn.dataset.residence;
        debug('Lo·∫°i c∆∞ tr√∫: ' + loaiCuTru);
      });
    });
    
    // ========== VALIDATION ==========
    function updateSubmitButton() {
      const canSubmit = selectedRoom && capturedImage;
      btnSubmit.disabled = !canSubmit;
      debug('Submit button: ' + (canSubmit ? 'enabled' : 'disabled') + 
            ' (room: ' + !!selectedRoom + ', image: ' + !!capturedImage + ')');
    }
    
    // ========== STATUS ==========
    function showStatus(type, title, message) {
      const icons = {
        loading: '<div class="spinner"></div>',
        success: '‚úÖ',
        error: '‚ùå'
      };
      
      statusEl.className = `status show ${type}`;
      statusEl.innerHTML = `
        <span class="status-icon">${icons[type]}</span>
        <div class="status-content">
          <strong>${title}</strong>
          <span>${message}</span>
        </div>
      `;
    }
    
    function hideStatus() {
      statusEl.className = 'status';
    }
    
    // ========== SUBMIT ==========
    async function submitCheckin() {
      if (!selectedRoom || !capturedImage) {
        showStatus('error', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng ch·ªçn ph√≤ng v√† ch·ª•p ·∫£nh gi·∫•y t·ªù');
        return;
      }
      
      if (APPS_SCRIPT_URL === 'THAY_URL_WEB_APP_V√ÄO_ƒê√ÇY') {
        showStatus('error', 'Ch∆∞a c·∫•u h√¨nh', 'Vui l√≤ng c·∫≠p nh·∫≠t APPS_SCRIPT_URL trong code');
        return;
      }
      
      btnSubmit.disabled = true;
      showStatus('loading', 'ƒêang x·ª≠ l√Ω...', 'ƒêang ƒë·ªçc th√¥ng tin t·ª´ gi·∫•y t·ªù');
      resultCard.classList.remove('show');
      
      debug('ƒêang g·ª≠i request ƒë·∫øn: ' + APPS_SCRIPT_URL);
      
      try {
        const requestBody = {
          action: 'checkin',
          image: capturedImage,
          roomNumber: selectedRoom,
          checkoutDate: document.getElementById('checkoutDate').value,
          lyDoLuuTru: lyDoLuuTru,
          loaiCuTru: loaiCuTru,
          isVietnamese: isVietnamese,
          phone: document.getElementById('phone').value
        };
        
        debug('Request body size: ' + Math.round(JSON.stringify(requestBody).length / 1024) + 'KB');
        
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify(requestBody)
        });
        
        debug('Response status: ' + response.status);
        
        const result = await response.json();
        debug('Response: ' + JSON.stringify(result).substring(0, 200));
        
        if (result.success) {
          const info = result.data.info;
          showStatus('success', 'Check-in th√†nh c√¥ng!', `Kh√°ch ${info.hoTen} ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n`);
          
          resultContent.innerHTML = `
            <div class="result-row">
              <span class="result-label">H·ªç t√™n</span>
              <span class="result-value">${info.hoTen || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Ng√†y sinh</span>
              <span class="result-value">${info.ngaySinh || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Gi·ªõi t√≠nh</span>
              <span class="result-value">${info.gioiTinh || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Qu·ªëc t·ªãch</span>
              <span class="result-value">${info.quocTich || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">S·ªë gi·∫•y t·ªù</span>
              <span class="result-value">${info.soGiayTo || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Ph√≤ng</span>
              <span class="result-value">${info.tenPhong || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">Check-in</span>
              <span class="result-value">${info.thoiGianTu || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">L√Ω do</span>
              <span class="result-value">${info.lyDoLuuTru || '-'}</span>
            </div>
            <div class="result-row">
              <span class="result-label">STT</span>
              <span class="result-value">#${result.data.stt}</span>
            </div>
          `;
          resultCard.classList.add('show');
          
        } else {
          showStatus('error', 'L·ªói x·ª≠ l√Ω', result.error || 'Kh√¥ng th·ªÉ ƒë·ªçc th√¥ng tin. Vui l√≤ng ch·ª•p l·∫°i ·∫£nh r√µ h∆°n.');
          btnSubmit.disabled = false;
        }
        
      } catch (error) {
        debug('Fetch error: ' + error.message);
        showStatus('error', 'L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server. Ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.');
        btnSubmit.disabled = false;
      }
    }
    
    // ========== QUICK ACTIONS ==========
    function newCheckin() {
      selectedRoom = '';
      capturedImage = null;
      
      document.querySelectorAll('.room-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('phone').value = '';
      document.getElementById('checkoutDate').value = getTomorrow();
      
      // Reset toggles
      document.querySelectorAll('[data-guest]').forEach(b => b.classList.remove('active'));
      document.querySelector('[data-guest="vn"]').classList.add('active');
      isVietnamese = true;
      vnExtraFields.style.display = 'block';
      
      document.querySelectorAll('[data-reason]').forEach(b => b.classList.remove('active'));
      document.querySelector('[data-reason="Du l·ªãch"]').classList.add('active');
      lyDoLuuTru = 'Du l·ªãch';
      
      document.querySelectorAll('[data-residence]').forEach(b => b.classList.remove('active'));
      document.querySelector('[data-residence="Th∆∞·ªùng tr√∫"]').classList.add('active');
      loaiCuTru = 'Th∆∞·ªùng tr√∫';
      
      hideStatus();
      resultCard.classList.remove('show');
      resetCamera();
      
      debug('Form ƒë√£ reset');
    }
    
    async function exportASM() {
      if (APPS_SCRIPT_URL === 'THAY_URL_WEB_APP_V√ÄO_ƒê√ÇY') {
        showStatus('error', 'Ch∆∞a c·∫•u h√¨nh', 'Vui l√≤ng c·∫≠p nh·∫≠t APPS_SCRIPT_URL trong code');
        return;
      }
      
      showStatus('loading', 'ƒêang xu·∫•t...', 'ƒêang t·∫°o file ASM Export');
      
      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'export_asm' })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('success', 'Xu·∫•t th√†nh c√¥ng!', result.data.message + '. M·ªü Google Sheet ƒë·ªÉ t·∫£i file.');
        } else {
          showStatus('error', 'L·ªói xu·∫•t', result.error || result.data?.message || 'Kh√¥ng c√≥ d·ªØ li·ªáu');
        }
      } catch (error) {
        showStatus('error', 'L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server');
        debug('Export error: ' + error.message);
      }
    }
    
    // ========== HELPERS ==========
    function getTomorrow() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      return tomorrow.toISOString().split('T')[0];
    }
    
    // ========== EVENT LISTENERS ==========
    btnCamera.addEventListener('click', startCamera);
    btnGallery.addEventListener('click', openGallery);
    btnRetake.addEventListener('click', resetCamera);
    btnSubmit.addEventListener('click', submitCheckin);
    fileInput.addEventListener('change', handleFileSelect);
    document.getElementById('btnNewCheckin').addEventListener('click', newCheckin);
    document.getElementById('btnExportASM').addEventListener('click', exportASM);
    
    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      debug('App kh·ªüi ƒë·ªông');
      
      // Set default checkout date
      document.getElementById('checkoutDate').value = getTomorrow();
      
      // Show device info
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      const isAndroid = /Android/.test(ua);
      document.getElementById('footerDebug').textContent = 
        (isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop') + ' | ' + 
        (navigator.mediaDevices ? 'Camera OK' : 'No Camera API');
      
      debug('Device: ' + (isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'));
      debug('mediaDevices: ' + !!navigator.mediaDevices);
      debug('getUserMedia: ' + !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
    });
  </script>
</body>
</html>

